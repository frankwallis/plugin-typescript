System.register(['typescript', './logger', './factory', './format-errors', './utils'], function(exports_1) {
    var ts, logger_1, factory_1, format_errors_1, utils_1;
    var logger, factory;
    function translate(load) {
        var _this = this;
        logger.debug("systemjs translating " + load.address);
        return factory.then(function (_a) {
            var transpiler = _a.transpiler, resolver = _a.resolver, typeChecker = _a.typeChecker, host = _a.host;
            host.addFile(load.address, load.source);
            if (utils_1.isTypescriptDeclaration(load.address)) {
                load.source = "";
            }
            else {
                var result = transpiler.transpile(load.address);
                format_errors_1.formatErrors(result.errors, logger);
                if (result.failure)
                    throw new Error("TypeScript transpilation failed");
                if (_this.loader && (host.options.module === 4))
                    load.source = wrapSource(result.js, load);
                else
                    load.source = result.js;
                if (result.sourceMap)
                    load.metadata.sourceMap = result.sourceMap;
                if (host.options.module === 4)
                    load.metadata.format = 'register';
                else if (host.options.module === 5)
                    load.metadata.format = 'esm';
                else if (host.options.module === 1)
                    load.metadata.format = 'cjs';
            }
            if (host.options.typeCheck && utils_1.isTypescript(load.address)) {
                return resolver.resolve(load.address)
                    .then(function (deps) {
                    var diags = typeChecker.check();
                    format_errors_1.formatErrors(diags, logger);
                    load.metadata.deps = deps.list.filter(utils_1.isTypescriptDeclaration).map(function (d) { return d + "!"; });
                    return load.source;
                });
            }
            else {
                return load.source;
            }
        });
    }
    exports_1("translate", translate);
    function bundle() {
        return factory.then(function (_a) {
            var typeChecker = _a.typeChecker, host = _a.host;
            if (host.options.typeCheck) {
                var errors = typeChecker.forceCheck();
                if (errors.length > 0) {
                    format_errors_1.formatErrors(errors, logger);
                    if (host.options.typeCheck === "strict")
                        throw new Error("Typescript compilation failed");
                }
            }
            return [];
        });
    }
    exports_1("bundle", bundle);
    function validateOptions(options) {
        if (options.module != 4) {
            if ((!System.transpiler || System.transpiler.indexOf("babel") < 0) || (options.target != 2))
                logger.warn("transpiling to " + ts.ModuleKind[options.module] + ", consider setting module: \"system\" in typescriptOptions to transpile directly to System.register format");
        }
    }
    function wrapSource(source, load) {
        return '(function(__moduleName){' + source + '\n})("' + load.name + '");\n//# sourceURL=' + load.address + '!transpiled';
    }
    function _resolve(dep, parent) {
        return System.normalize(dep, parent)
            .then(function (normalized) {
            normalized = utils_1.stripDoubleExtension(normalized);
            logger.debug("resolved " + normalized + " (" + parent + " -> " + dep + ")");
            return ts.normalizePath(normalized);
        });
    }
    function _fetch(address) {
        return System.fetch({ address: address, name: address, metadata: {} })
            .then(function (text) {
            logger.debug("fetched " + address);
            return text;
        });
    }
    return {
        setters:[
            function (ts_1) {
                ts = ts_1;
            },
            function (logger_1_1) {
                logger_1 = logger_1_1;
            },
            function (factory_1_1) {
                factory_1 = factory_1_1;
            },
            function (format_errors_1_1) {
                format_errors_1 = format_errors_1_1;
            },
            function (utils_1_1) {
                utils_1 = utils_1_1;
            }],
        execute: function() {
            logger = new logger_1.default({ debug: false });
            factory = factory_1.createFactory(System.typescriptOptions, _resolve, _fetch)
                .then(function (output) {
                validateOptions(output.host.options);
                return output;
            });
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3BsdWdpbi50cyJdLCJuYW1lcyI6WyJ0cmFuc2xhdGUiLCJidW5kbGUiLCJ2YWxpZGF0ZU9wdGlvbnMiLCJ3cmFwU291cmNlIiwiX3Jlc29sdmUiLCJfZmV0Y2giXSwibWFwcGluZ3MiOiI7O1FBT00sTUFBTSxFQUNOLE9BQU87SUFZYixtQkFBMEIsSUFBWTtRQUF0Q0EsaUJBaURDQTtRQWhEQUEsTUFBTUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsMEJBQXdCQSxJQUFJQSxDQUFDQSxPQUFTQSxDQUFDQSxDQUFDQTtRQUVyREEsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBQ0EsRUFBeUNBO2dCQUF4Q0EsVUFBVUEsa0JBQUVBLFFBQVFBLGdCQUFFQSxXQUFXQSxtQkFBRUEsSUFBSUE7WUFDeERBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLEVBQUVBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO1lBR3hDQSxFQUFFQSxDQUFDQSxDQUFDQSwrQkFBdUJBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUN6Q0EsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsRUFBRUEsQ0FBQ0E7WUFDcEJBLENBQUNBO1lBQ0RBLElBQUlBLENBQUNBLENBQUNBO2dCQUNIQSxJQUFNQSxNQUFNQSxHQUFHQSxVQUFVQSxDQUFDQSxTQUFTQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtnQkFDbERBLDRCQUFZQSxDQUFDQSxNQUFNQSxDQUFDQSxNQUFNQSxFQUFFQSxNQUFNQSxDQUFDQSxDQUFDQTtnQkFFcENBLEVBQUVBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBO29CQUNoQkEsTUFBTUEsSUFBSUEsS0FBS0EsQ0FBQ0EsaUNBQWlDQSxDQUFDQSxDQUFDQTtnQkFFdERBLEVBQUVBLENBQUNBLENBQUNBLEtBQUlBLENBQUNBLE1BQU1BLElBQUlBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLE1BQU1BLEtBQUtBLENBQW9CQSxDQUFDQSxDQUFDQTtvQkFDL0RBLElBQUlBLENBQUNBLE1BQU1BLEdBQUdBLFVBQVVBLENBQUNBLE1BQU1BLENBQUNBLEVBQUVBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO2dCQUM3Q0EsSUFBSUE7b0JBQ0RBLElBQUlBLENBQUNBLE1BQU1BLEdBQUdBLE1BQU1BLENBQUNBLEVBQUVBLENBQUNBO2dCQUUzQkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsU0FBU0EsQ0FBQ0E7b0JBQ2xCQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxTQUFTQSxHQUFHQSxNQUFNQSxDQUFDQSxTQUFTQSxDQUFDQTtnQkFFOUNBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLE1BQU1BLEtBQUtBLENBQW9CQSxDQUFDQTtvQkFDOUNBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLE1BQU1BLEdBQUdBLFVBQVVBLENBQUNBO2dCQUNyQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsTUFBTUEsS0FBS0EsQ0FBaUJBLENBQUNBO29CQUNoREEsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsTUFBTUEsR0FBR0EsS0FBS0EsQ0FBQ0E7Z0JBQ2hDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxNQUFNQSxLQUFLQSxDQUFzQkEsQ0FBQ0E7b0JBQ3JEQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxNQUFNQSxHQUFHQSxLQUFLQSxDQUFDQTtZQUNuQ0EsQ0FBQ0E7WUFHREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsU0FBU0EsSUFBSUEsb0JBQVlBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUN4REEsTUFBTUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0E7cUJBQ2pDQSxJQUFJQSxDQUFDQSxVQUFBQSxJQUFJQTtvQkFDUEEsSUFBSUEsS0FBS0EsR0FBR0EsV0FBV0EsQ0FBQ0EsS0FBS0EsRUFBRUEsQ0FBQ0E7b0JBQ2hDQSw0QkFBWUEsQ0FBQ0EsS0FBS0EsRUFBRUEsTUFBTUEsQ0FBQ0EsQ0FBQ0E7b0JBRzVCQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSwrQkFBdUJBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLFVBQUFBLENBQUNBLElBQUlBLE9BQUFBLENBQUNBLEdBQUdBLEdBQUdBLEVBQVBBLENBQU9BLENBQUNBLENBQUNBO29CQUNqRkEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7Z0JBQ3RCQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNUQSxDQUFDQTtZQUNEQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDSEEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7WUFDdEJBLENBQUNBO1FBQ0pBLENBQUNBLENBQUNBLENBQUNBO0lBQ05BLENBQUNBO0lBakRELGlDQWlEQyxDQUFBO0lBRUQ7UUFDR0MsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBQ0EsRUFBbUJBO2dCQUFsQkEsV0FBV0EsbUJBQUVBLElBQUlBO1lBRXBDQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDMUJBLElBQU1BLE1BQU1BLEdBQUdBLFdBQVdBLENBQUNBLFVBQVVBLEVBQUVBLENBQUNBO2dCQUV4Q0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQ3JCQSw0QkFBWUEsQ0FBQ0EsTUFBTUEsRUFBRUEsTUFBTUEsQ0FBQ0EsQ0FBQ0E7b0JBRTdCQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxTQUFTQSxLQUFLQSxRQUFRQSxDQUFDQTt3QkFDckNBLE1BQU1BLElBQUlBLEtBQUtBLENBQUNBLCtCQUErQkEsQ0FBQ0EsQ0FBQ0E7Z0JBQ3ZEQSxDQUFDQTtZQUNKQSxDQUFDQTtZQUVEQSxNQUFNQSxDQUFDQSxFQUFFQSxDQUFDQTtRQUNiQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUNOQSxDQUFDQTtJQWhCRCwyQkFnQkMsQ0FBQTtJQUVELHlCQUF5QixPQUFPO1FBRzdCQyxFQUFFQSxDQUFDQSxDQUFDQSxPQUFPQSxDQUFDQSxNQUFNQSxJQUFJQSxDQUFvQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDMUNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLFVBQVVBLElBQUlBLE1BQU1BLENBQUNBLFVBQVVBLENBQUNBLE9BQU9BLENBQUNBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLE1BQU1BLElBQUlBLENBQW1CQSxDQUFDQSxDQUFDQTtnQkFDM0dBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLG9CQUF3QkEsRUFBR0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsK0dBQTBHQSxDQUFDQSxDQUFDQTtRQUNwTEEsQ0FBQ0E7SUFDSkEsQ0FBQ0E7SUFFRCxvQkFBb0IsTUFBYyxFQUFFLElBQVk7UUFDL0NDLE1BQU1BLENBQUNBLDBCQUEwQkEsR0FBR0EsTUFBTUEsR0FBR0EsUUFBUUEsR0FBR0EsSUFBSUEsQ0FBQ0EsSUFBSUEsR0FBR0EscUJBQXFCQSxHQUFHQSxJQUFJQSxDQUFDQSxPQUFPQSxHQUFHQSxhQUFhQSxDQUFDQTtJQUMxSEEsQ0FBQ0E7SUFLRCxrQkFBa0IsR0FBVyxFQUFFLE1BQWM7UUFJNUNDLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLFNBQVNBLENBQUNBLEdBQUdBLEVBQUVBLE1BQU1BLENBQUNBO2FBQ2xDQSxJQUFJQSxDQUFDQSxVQUFBQSxVQUFVQTtZQUNmQSxVQUFVQSxHQUFHQSw0QkFBb0JBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBO1lBRTlDQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQSxjQUFZQSxVQUFVQSxVQUFLQSxNQUFNQSxZQUFPQSxHQUFHQSxNQUFHQSxDQUFDQSxDQUFDQTtZQUN2REEsTUFBTUEsQ0FBRUEsRUFBVUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0E7UUFDcERBLENBQUNBLENBQUNBLENBQUNBO0lBQ0xBLENBQUNBO0lBS0QsZ0JBQWdCLE9BQWU7UUFDOUJDLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBLEVBQUVBLE9BQU9BLEVBQUVBLE9BQU9BLEVBQUVBLElBQUlBLEVBQUVBLE9BQU9BLEVBQUVBLFFBQVFBLEVBQUVBLEVBQUVBLEVBQUVBLENBQUNBO2FBQ3BFQSxJQUFJQSxDQUFDQSxVQUFBQSxJQUFJQTtZQUNUQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQSxhQUFXQSxPQUFTQSxDQUFDQSxDQUFDQTtZQUNuQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7UUFDYkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDTEEsQ0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7WUF4SEssTUFBTSxHQUFHLElBQUksZ0JBQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ3RDLE9BQU8sR0FBRyx1QkFBYSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDO2lCQUNyRSxJQUFJLENBQUMsVUFBQyxNQUFNO2dCQUNWLGVBQWUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNyQyxNQUFNLENBQUMsTUFBTSxDQUFDO1lBQ2pCLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogKi9cclxuaW1wb3J0ICogYXMgdHMgZnJvbSAndHlwZXNjcmlwdCc7XHJcbmltcG9ydCBMb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xyXG5pbXBvcnQge2NyZWF0ZUZhY3Rvcnl9IGZyb20gJy4vZmFjdG9yeSc7XHJcbmltcG9ydCB7Zm9ybWF0RXJyb3JzfSBmcm9tICcuL2Zvcm1hdC1lcnJvcnMnO1xyXG5pbXBvcnQge2lzVHlwZXNjcmlwdCwgaXNUeXBlc2NyaXB0RGVjbGFyYXRpb24sIHN0cmlwRG91YmxlRXh0ZW5zaW9ufSBmcm9tICcuL3V0aWxzJztcclxuXHJcbmNvbnN0IGxvZ2dlciA9IG5ldyBMb2dnZXIoeyBkZWJ1ZzogZmFsc2UgfSk7XHJcbmNvbnN0IGZhY3RvcnkgPSBjcmVhdGVGYWN0b3J5KFN5c3RlbS50eXBlc2NyaXB0T3B0aW9ucywgX3Jlc29sdmUsIF9mZXRjaClcclxuICAgLnRoZW4oKG91dHB1dCkgPT4ge1xyXG4gICAgICB2YWxpZGF0ZU9wdGlvbnMob3V0cHV0Lmhvc3Qub3B0aW9ucyk7XHJcbiAgICAgIHJldHVybiBvdXRwdXQ7XHJcbiAgIH0pO1xyXG4gICBcclxuLypcclxuICogbG9hZC5uYW1lXHJcbiAqIGxvYWQuYWRkcmVzc1xyXG4gKiBsb2FkLm1ldGFkYXRhXHJcbiAqIGxvYWQuc291cmNlOiB0aGUgZmV0Y2hlZCBzb3VyY2VcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiB0cmFuc2xhdGUobG9hZDogTW9kdWxlKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuXHRsb2dnZXIuZGVidWcoYHN5c3RlbWpzIHRyYW5zbGF0aW5nICR7bG9hZC5hZGRyZXNzfWApO1xyXG5cclxuXHRyZXR1cm4gZmFjdG9yeS50aGVuKCh7dHJhbnNwaWxlciwgcmVzb2x2ZXIsIHR5cGVDaGVja2VyLCBob3N0fSkgPT4geyAgICAgICAgICAgIFxyXG4gICAgICBob3N0LmFkZEZpbGUobG9hZC5hZGRyZXNzLCBsb2FkLnNvdXJjZSk7XHJcblxyXG4gICAgICAvLyB0cmFuc3BpbGVcclxuICAgICAgaWYgKGlzVHlwZXNjcmlwdERlY2xhcmF0aW9uKGxvYWQuYWRkcmVzcykpIHtcclxuICAgICAgICAgbG9hZC5zb3VyY2UgPSBcIlwiO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgICBjb25zdCByZXN1bHQgPSB0cmFuc3BpbGVyLnRyYW5zcGlsZShsb2FkLmFkZHJlc3MpO1xyXG4gICAgICAgICBmb3JtYXRFcnJvcnMocmVzdWx0LmVycm9ycywgbG9nZ2VyKTtcclxuXHJcbiAgICAgICAgIGlmIChyZXN1bHQuZmFpbHVyZSlcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVHlwZVNjcmlwdCB0cmFuc3BpbGF0aW9uIGZhaWxlZFwiKTtcclxuXHJcbiAgICAgICAgIGlmICh0aGlzLmxvYWRlciAmJiAoaG9zdC5vcHRpb25zLm1vZHVsZSA9PT0gdHMuTW9kdWxlS2luZC5TeXN0ZW0pKVxyXG4gICAgICAgICAgICBsb2FkLnNvdXJjZSA9IHdyYXBTb3VyY2UocmVzdWx0LmpzLCBsb2FkKTtcclxuICAgICAgICAgZWxzZSBcclxuICAgICAgICAgICAgbG9hZC5zb3VyY2UgPSByZXN1bHQuanM7XHJcbiAgICAgICAgIFxyXG4gICAgICAgICBpZiAocmVzdWx0LnNvdXJjZU1hcClcclxuICAgICAgICAgICAgbG9hZC5tZXRhZGF0YS5zb3VyY2VNYXAgPSByZXN1bHQuc291cmNlTWFwO1xyXG4gICAgICAgICBcclxuICAgICAgICAgaWYgKGhvc3Qub3B0aW9ucy5tb2R1bGUgPT09IHRzLk1vZHVsZUtpbmQuU3lzdGVtKVxyXG4gICAgICAgICAgICBsb2FkLm1ldGFkYXRhLmZvcm1hdCA9ICdyZWdpc3Rlcic7XHJcbiAgICAgICAgIGVsc2UgaWYgKGhvc3Qub3B0aW9ucy5tb2R1bGUgPT09IHRzLk1vZHVsZUtpbmQuRVM2KVxyXG4gICAgICAgICAgICBsb2FkLm1ldGFkYXRhLmZvcm1hdCA9ICdlc20nO1x0XHRcdFxyXG4gICAgICAgICBlbHNlIGlmIChob3N0Lm9wdGlvbnMubW9kdWxlID09PSB0cy5Nb2R1bGVLaW5kLkNvbW1vbkpTKVxyXG4gICAgICAgICAgICBsb2FkLm1ldGFkYXRhLmZvcm1hdCA9ICdjanMnO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICAvLyB0eXBlLWNoZWNrP1xyXG4gICAgICBpZiAoaG9zdC5vcHRpb25zLnR5cGVDaGVjayAmJiBpc1R5cGVzY3JpcHQobG9hZC5hZGRyZXNzKSkge1xyXG4gICAgICAgICByZXR1cm4gcmVzb2x2ZXIucmVzb2x2ZShsb2FkLmFkZHJlc3MpXHJcbiAgICAgICAgICAgIC50aGVuKGRlcHMgPT4ge1xyXG4gICAgICAgICAgICAgICB2YXIgZGlhZ3MgPSB0eXBlQ2hlY2tlci5jaGVjaygpO1xyXG4gICAgICAgICAgICAgICBmb3JtYXRFcnJvcnMoZGlhZ3MsIGxvZ2dlcik7XHJcbiAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAvLyB0aGlzIG1ha2VzIFN5c3RlbUpTIGZldGNoIG91ciBkZWNsYXJhdGlvbiBmaWxlcyBmb3IgdXNcclxuICAgICAgICAgICAgICAgbG9hZC5tZXRhZGF0YS5kZXBzID0gZGVwcy5saXN0LmZpbHRlcihpc1R5cGVzY3JpcHREZWNsYXJhdGlvbikubWFwKGQgPT4gZCArIFwiIVwiKTtcclxuICAgICAgICAgICAgICAgcmV0dXJuIGxvYWQuc291cmNlO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICAgcmV0dXJuIGxvYWQuc291cmNlOyAgICAgICAgICAgICAgICAgIFxyXG4gICAgICB9XHJcbiAgIH0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gYnVuZGxlKCkge1xyXG4gICByZXR1cm4gZmFjdG9yeS50aGVuKCh7dHlwZUNoZWNrZXIsIGhvc3R9KSA9PiB7XHJcbiAgICAgIFxyXG4gICAgICBpZiAoaG9zdC5vcHRpb25zLnR5cGVDaGVjaykge1xyXG4gICAgICAgICBjb25zdCBlcnJvcnMgPSB0eXBlQ2hlY2tlci5mb3JjZUNoZWNrKCk7XHJcbiAgICAgICAgIFxyXG4gICAgICAgICBpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgZm9ybWF0RXJyb3JzKGVycm9ycywgbG9nZ2VyKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChob3N0Lm9wdGlvbnMudHlwZUNoZWNrID09PSBcInN0cmljdFwiKVxyXG4gICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUeXBlc2NyaXB0IGNvbXBpbGF0aW9uIGZhaWxlZFwiKTtcclxuICAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICByZXR1cm4gW107XHJcbiAgIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiB2YWxpZGF0ZU9wdGlvbnMob3B0aW9ucykge1xyXG4gICAvKiBUaGUgb25seSB0aW1lIHlvdSBkb24ndCB3YW50IHRvIG91dHB1dCBpbiBzeXN0ZW0gZm9ybWF0IGlzIHdoZW4geW91IGFyZSB1c2luZyBiYWJlbCBcclxuICAgICAgZG93bnN0cmVhbSB0byBjb21waWxlIGVzNiBvdXRwdXQgKGUuZy4gZm9yIGFzeW5jL2F3YWl0IHN1cHBvcnQpICovICAgICAgXHJcbiAgIGlmIChvcHRpb25zLm1vZHVsZSAhPSB0cy5Nb2R1bGVLaW5kLlN5c3RlbSkgeyAgICAgIFxyXG4gICAgICBpZiAoKCFTeXN0ZW0udHJhbnNwaWxlciB8fCBTeXN0ZW0udHJhbnNwaWxlci5pbmRleE9mKFwiYmFiZWxcIikgPCAwKSB8fCAob3B0aW9ucy50YXJnZXQgIT0gdHMuU2NyaXB0VGFyZ2V0LkVTNikpXHJcbiAgICAgICAgIGxvZ2dlci53YXJuKGB0cmFuc3BpbGluZyB0byAkeyg8YW55PnRzKS5Nb2R1bGVLaW5kW29wdGlvbnMubW9kdWxlXX0sIGNvbnNpZGVyIHNldHRpbmcgbW9kdWxlOiBcInN5c3RlbVwiIGluIHR5cGVzY3JpcHRPcHRpb25zIHRvIHRyYW5zcGlsZSBkaXJlY3RseSB0byBTeXN0ZW0ucmVnaXN0ZXIgZm9ybWF0YCk7XHJcbiAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gd3JhcFNvdXJjZShzb3VyY2U6IHN0cmluZywgbG9hZDogTW9kdWxlKTogc3RyaW5nIHtcclxuXHRyZXR1cm4gJyhmdW5jdGlvbihfX21vZHVsZU5hbWUpeycgKyBzb3VyY2UgKyAnXFxufSkoXCInICsgbG9hZC5uYW1lICsgJ1wiKTtcXG4vLyMgc291cmNlVVJMPScgKyBsb2FkLmFkZHJlc3MgKyAnIXRyYW5zcGlsZWQnO1xyXG59XHJcblxyXG4vKlxyXG4gKiBjYWxsZWQgYnkgdGhlIGZhY3RvcnkvcmVzb2x2ZXIgd2hlbiBpdCBuZWVkcyB0byByZXNvbHZlIGEgZmlsZVxyXG4gKi9cclxuZnVuY3Rpb24gX3Jlc29sdmUoZGVwOiBzdHJpbmcsIHBhcmVudDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuXHQvLyBUT0RPOiBfX21vZHVsZU5hbWUgaXMgbm90IGF2YWlsYWJsZSB3aXRob3V0IGEgYnVpbHQtaW4gdHJhbnNwaWxlclxyXG5cdC8vaWYgKCFwYXJlbnQpIHBhcmVudCA9IF9fbW9kdWxlTmFtZTtcclxuXHJcblx0cmV0dXJuIFN5c3RlbS5ub3JtYWxpemUoZGVwLCBwYXJlbnQpXHJcblx0XHQudGhlbihub3JtYWxpemVkID0+IHtcclxuXHRcdFx0bm9ybWFsaXplZCA9IHN0cmlwRG91YmxlRXh0ZW5zaW9uKG5vcm1hbGl6ZWQpO1xyXG5cclxuXHRcdFx0bG9nZ2VyLmRlYnVnKGByZXNvbHZlZCAke25vcm1hbGl6ZWR9ICgke3BhcmVudH0gLT4gJHtkZXB9KWApO1xyXG4gICAgICAgICByZXR1cm4gKHRzIGFzIGFueSkubm9ybWFsaXplUGF0aChub3JtYWxpemVkKTtcclxuXHRcdH0pO1xyXG59XHJcblxyXG4vKlxyXG4gKiBjYWxsZWQgYnkgdGhlIGZhY3RvcnkvcmVzb2x2ZXIgd2hlbiBpdCBuZWVkcyB0byBmZXRjaCBhIGZpbGVcclxuICovXHJcbmZ1bmN0aW9uIF9mZXRjaChhZGRyZXNzOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xyXG5cdHJldHVybiBTeXN0ZW0uZmV0Y2goeyBhZGRyZXNzOiBhZGRyZXNzLCBuYW1lOiBhZGRyZXNzLCBtZXRhZGF0YToge30gfSlcclxuXHRcdC50aGVuKHRleHQgPT4ge1xyXG5cdFx0XHRsb2dnZXIuZGVidWcoYGZldGNoZWQgJHthZGRyZXNzfWApO1xyXG5cdFx0XHRyZXR1cm4gdGV4dDtcclxuXHRcdH0pO1xyXG59XHJcbiJdfQ==