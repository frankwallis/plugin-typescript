System.register(['typescript', './logger', './factory', './format-errors', './utils'], function(exports_1) {
    var ts, logger_1, factory_1, format_errors_1, utils_1;
    var logger, factory, typeCheckErrored;
    function translate(load) {
        var _this = this;
        logger.debug("systemjs translating " + load.address);
        return factory.then(function (_a) {
            var transpiler = _a.transpiler, typeChecker = _a.typeChecker, host = _a.host;
            var result = transpiler.transpile(load.address, load.source);
            format_errors_1.formatErrors(result.errors, logger);
            if (result.failure)
                throw new Error("TypeScript transpilation failed");
            if (host.options.typeCheck && utils_1.isTypescript(load.address)) {
                typeChecker.check(load.address, load.source)
                    .catch(function (err) { return logger.error(err.message); })
                    .then(function (diags) {
                    format_errors_1.formatErrors(diags, logger);
                    if (diags.some(function (diag) { return diag.category === ts.DiagnosticCategory.Error; }))
                        typeCheckErrored = true;
                });
            }
            if (_this.loader && (host.options.module === 4))
                load.source = wrapSource(result.js, load);
            else
                load.source = result.js;
            if (result.sourceMap) {
                if (_this.transpiler && _this.transpiler.indexOf("babel") >= 0)
                    load.metadata.sourceMap = JSON.parse(result.sourceMap);
                else
                    load.metadata.sourceMap = result.sourceMap;
            }
            if (host.options.module === 4)
                load.metadata.format = 'register';
            else if (host.options.module === 5)
                load.metadata.format = 'esm';
            return load.source;
        });
    }
    exports_1("translate", translate);
    function wrapSource(source, load) {
        return '(function(__moduleName){' + source + '\n})("' + load.name + '");\n//# sourceURL=' + load.address + '!transpiled';
    }
    function bundle() {
        if (typeCheckErrored && System.typescriptOptions.typeCheck === "strict") {
            typeCheckErrored = false;
            throw new Error("TypeScript found type errors");
        }
        return [];
    }
    exports_1("bundle", bundle);
    function _resolve(dep, parent) {
        return System.normalize(dep, parent)
            .then(function (normalized) {
            normalized = utils_1.stripDoubleExtension(normalized);
            logger.debug("resolved " + normalized + " (" + parent + " -> " + dep + ")");
            return normalized;
        });
    }
    function _fetch(address) {
        return System.fetch({ address: address, name: address, metadata: {} })
            .then(function (text) {
            logger.debug("fetched " + address);
            return text;
        });
    }
    return {
        setters:[
            function (ts_1) {
                ts = ts_1;
            },
            function (logger_1_1) {
                logger_1 = logger_1_1;
            },
            function (factory_1_1) {
                factory_1 = factory_1_1;
            },
            function (format_errors_1_1) {
                format_errors_1 = format_errors_1_1;
            },
            function (utils_1_1) {
                utils_1 = utils_1_1;
            }],
        execute: function() {
            logger = new logger_1.default({ debug: false });
            factory = factory_1.createFactory(System.typescriptOptions, _resolve, _fetch);
            typeCheckErrored = false;
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3BsdWdpbi50cyJdLCJuYW1lcyI6WyJ0cmFuc2xhdGUiLCJ3cmFwU291cmNlIiwiYnVuZGxlIiwiX3Jlc29sdmUiLCJfZmV0Y2giXSwibWFwcGluZ3MiOiI7O1FBT0ksTUFBTSxFQUNOLE9BQU8sRUFDUCxnQkFBZ0I7SUFRcEIsbUJBQTBCLElBQVk7UUFBdENBLGlCQXdDQ0E7UUF2Q0FBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBLDBCQUF3QkEsSUFBSUEsQ0FBQ0EsT0FBU0EsQ0FBQ0EsQ0FBQ0E7UUFFckRBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLFVBQUNBLEVBQStCQTtnQkFBOUJBLFVBQVVBLGtCQUFFQSxXQUFXQSxtQkFBRUEsSUFBSUE7WUFDbERBLElBQUlBLE1BQU1BLEdBQUdBLFVBQVVBLENBQUNBLFNBQVNBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLEVBQUVBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO1lBQzdEQSw0QkFBWUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsRUFBRUEsTUFBTUEsQ0FBQ0EsQ0FBQ0E7WUFFcENBLEVBQUVBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBO2dCQUNsQkEsTUFBTUEsSUFBSUEsS0FBS0EsQ0FBQ0EsaUNBQWlDQSxDQUFDQSxDQUFDQTtZQUVwREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsU0FBU0EsSUFBSUEsb0JBQVlBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUMxREEsV0FBV0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsRUFBRUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7cUJBQzFDQSxLQUFLQSxDQUFDQSxVQUFBQSxHQUFHQSxJQUFJQSxPQUFBQSxNQUFNQSxD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QUE7SUFLRCxrQkFBa0IsR0FBVyxFQUFFLE1BQWM7UUFJNUNDLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLFNBQVNBLENBQUNBLEdBQUdBLEVBQUVBLE1BQU1BLENBQUNBO2FBQ2xDQSxJQUFJQSxDQUFDQSxVQUFBQSxVQUFVQTtZQUNmQSxVQUFVQSxHQUFHQSw0QkFBb0JBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBO1lBRTlDQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQSxjQUFZQSxVQUFVQSxVQUFLQSxNQUFNQSxZQUFPQSxHQUFHQSxNQUFHQSxDQUFDQSxDQUFDQTtZQUM3REEsTUFBTUEsQ0FBQ0EsVUFBVUEsQ0FBQ0E7UUFDbkJBLENBQUNBLENBQUNBLENBQUNBO0lBQ0xBLENBQUNBO0lBS0QsZ0JBQWdCLE9BQWU7UUFDOUJDLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBLEVBQUVBLE9BQU9BLEVBQUVBLE9BQU9BLEVBQUVBLElBQUlBLEVBQUVBLE9BQU9BLEVBQUVBLFFBQVFBLEVBQUVBLEVBQUVBLEVBQUVBLENBQUNBO2FBQ3BFQSxJQUFJQSxDQUFDQSxVQUFBQSxJQUFJQTtZQUNUQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQSxhQUFXQSxPQUFTQSxDQUFDQSxDQUFDQTtZQUNuQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7UUFDYkEsQ0FBQ0EsQ0FBQ0EsQ0FBQUE7SUFDSkEsQ0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7WUExRkcsTUFBTSxHQUFHLElBQUksZ0JBQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ3RDLE9BQU8sR0FBRyx1QkFBYSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDcEUsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogKi9cbmltcG9ydCAqIGFzIHRzIGZyb20gJ3R5cGVzY3JpcHQnO1xuaW1wb3J0IExvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQge2NyZWF0ZUZhY3Rvcnl9IGZyb20gJy4vZmFjdG9yeSc7XG5pbXBvcnQge2Zvcm1hdEVycm9yc30gZnJvbSAnLi9mb3JtYXQtZXJyb3JzJztcbmltcG9ydCB7aXNUeXBlc2NyaXB0LCBzdHJpcERvdWJsZUV4dGVuc2lvbn0gZnJvbSAnLi91dGlscyc7XG5cbmxldCBsb2dnZXIgPSBuZXcgTG9nZ2VyKHsgZGVidWc6IGZhbHNlIH0pO1xubGV0IGZhY3RvcnkgPSBjcmVhdGVGYWN0b3J5KFN5c3RlbS50eXBlc2NyaXB0T3B0aW9ucywgX3Jlc29sdmUsIF9mZXRjaCk7XG5sZXQgdHlwZUNoZWNrRXJyb3JlZCA9IGZhbHNlO1xuXG4vKlxuICogbG9hZC5uYW1lXG4gKiBsb2FkLmFkZHJlc3NcbiAqIGxvYWQubWV0YWRhdGFcbiAqIGxvYWQuc291cmNlOiB0aGUgZmV0Y2hlZCBzb3VyY2VcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHRyYW5zbGF0ZShsb2FkOiBNb2R1bGUpOiBQcm9taXNlPHN0cmluZz4ge1xuXHRsb2dnZXIuZGVidWcoYHN5c3RlbWpzIHRyYW5zbGF0aW5nICR7bG9hZC5hZGRyZXNzfWApO1xuXG5cdHJldHVybiBmYWN0b3J5LnRoZW4oKHt0cmFuc3BpbGVyLCB0eXBlQ2hlY2tlciwgaG9zdH0pID0+IHtcblx0XHRsZXQgcmVzdWx0ID0gdHJhbnNwaWxlci50cmFuc3BpbGUobG9hZC5hZGRyZXNzLCBsb2FkLnNvdXJjZSk7XG5cdFx0Zm9ybWF0RXJyb3JzKHJlc3VsdC5lcnJvcnMsIGxvZ2dlcik7XG5cblx0XHRpZiAocmVzdWx0LmZhaWx1cmUpXG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoXCJUeXBlU2NyaXB0IHRyYW5zcGlsYXRpb24gZmFpbGVkXCIpO1xuXG5cdFx0aWYgKGhvc3Qub3B0aW9ucy50eXBlQ2hlY2sgJiYgaXNUeXBlc2NyaXB0KGxvYWQuYWRkcmVzcykpIHtcblx0XHRcdHR5cGVDaGVja2VyLmNoZWNrKGxvYWQuYWRkcmVzcywgbG9hZC5zb3VyY2UpXG5cdFx0XHRcdC5jYXRjaChlcnIgPT4gbG9nZ2VyLmVycm9yKGVyci5tZXNzYWdlKSlcblx0XHRcdFx0LnRoZW4oZGlhZ3MgPT4ge1xuXHRcdFx0XHRcdGZvcm1hdEVycm9ycyhkaWFncywgbG9nZ2VyKTtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRpZiAoZGlhZ3Muc29tZShkaWFnID0+IGRpYWcuY2F0ZWdvcnkgPT09IHRzLkRpYWdub3N0aWNDYXRlZ29yeS5FcnJvcikpXG5cdFx0XHRcdFx0XHR0eXBlQ2hlY2tFcnJvcmVkID0gdHJ1ZTtcblx0XHRcdFx0fSk7XG5cdFx0fVxuXG5cdFx0aWYgKHRoaXMubG9hZGVyICYmIChob3N0Lm9wdGlvbnMubW9kdWxlID09PSB0cy5Nb2R1bGVLaW5kLlN5c3RlbSkpXG5cdFx0XHRsb2FkLnNvdXJjZSA9IHdyYXBTb3VyY2UocmVzdWx0LmpzLCBsb2FkKTtcblx0XHRlbHNlIFxuXHRcdFx0bG9hZC5zb3VyY2UgPSByZXN1bHQuanM7XG5cdFx0XG5cdFx0aWYgKHJlc3VsdC5zb3VyY2VNYXApIHtcbiAgICAgICAgIGlmICh0aGlzLnRyYW5zcGlsZXIgJiYgdGhpcy50cmFuc3BpbGVyLmluZGV4T2YoXCJiYWJlbFwiKSA+PSAwKVxuICAgXHRcdFx0bG9hZC5tZXRhZGF0YS5zb3VyY2VNYXAgPSBKU09OLnBhcnNlKHJlc3VsdC5zb3VyY2VNYXApO1xuICAgICAgICAgZWxzZVxuICAgICAgICAgICAgbG9hZC5tZXRhZGF0YS5zb3VyY2VNYXAgPSByZXN1bHQuc291cmNlTWFwO1xuICAgICAgfVxuXHRcdFxuXHRcdGlmIChob3N0Lm9wdGlvbnMubW9kdWxlID09PSB0cy5Nb2R1bGVLaW5kLlN5c3RlbSlcblx0XHRcdGxvYWQubWV0YWRhdGEuZm9ybWF0ID0gJ3JlZ2lzdGVyJztcblx0XHRlbHNlIGlmIChob3N0Lm9wdGlvbnMubW9kdWxlID09PSB0cy5Nb2R1bGVLaW5kLkVTNilcblx0XHRcdGxvYWQubWV0YWRhdGEuZm9ybWF0ID0gJ2VzbSc7XHRcdFx0XG5cblx0XHRyZXR1cm4gbG9hZC5zb3VyY2U7XG5cdH0pO1xufVxuXG5mdW5jdGlvbiB3cmFwU291cmNlKHNvdXJjZTogc3RyaW5nLCBsb2FkOiBNb2R1bGUpOiBzdHJpbmcge1xuXHRyZXR1cm4gJyhmdW5jdGlvbihfX21vZHVsZU5hbWUpeycgKyBzb3VyY2UgKyAnXFxufSkoXCInICsgbG9hZC5uYW1lICsgJ1wiKTtcXG4vLyMgc291cmNlVVJMPScgKyBsb2FkLmFkZHJlc3MgKyAnIXRyYW5zcGlsZWQnO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVuZGxlKCkge1xuXHRpZiAodHlwZUNoZWNrRXJyb3JlZCAmJiBTeXN0ZW0udHlwZXNjcmlwdE9wdGlvbnMudHlwZUNoZWNrID09PSBcInN0cmljdFwiKSB7XG5cdFx0dHlwZUNoZWNrRXJyb3JlZCA9IGZhbHNlO1xuXHRcdHRocm93IG5ldyBFcnJvcihcIlR5cGVTY3JpcHQgZm91bmQgdHlwZSBlcnJvcnNcIik7XG5cdH1cblx0XG5cdHJldHVybiBbXTtcbn1cblxuLypcbiAqIGNhbGxlZCBieSB0aGUgdHlwZS1jaGVja2VyIHdoZW4gaXQgbmVlZHMgdG8gcmVzb2x2ZSBhIGZpbGVcbiAqL1xuZnVuY3Rpb24gX3Jlc29sdmUoZGVwOiBzdHJpbmcsIHBhcmVudDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcblx0Ly8gVE9ETzogX19tb2R1bGVOYW1lIGlzIG5vdCBhdmFpbGFibGUgd2l0aG91dCBhIGJ1aWx0LWluIHRyYW5zcGlsZXJcblx0Ly9pZiAoIXBhcmVudCkgcGFyZW50ID0gX19tb2R1bGVOYW1lO1xuXG5cdHJldHVybiBTeXN0ZW0ubm9ybWFsaXplKGRlcCwgcGFyZW50KVxuXHRcdC50aGVuKG5vcm1hbGl6ZWQgPT4ge1xuXHRcdFx0bm9ybWFsaXplZCA9IHN0cmlwRG91YmxlRXh0ZW5zaW9uKG5vcm1hbGl6ZWQpO1xuXG5cdFx0XHRsb2dnZXIuZGVidWcoYHJlc29sdmVkICR7bm9ybWFsaXplZH0gKCR7cGFyZW50fSAtPiAke2RlcH0pYCk7XG5cdFx0XHRyZXR1cm4gbm9ybWFsaXplZDtcblx0XHR9KTtcbn1cblxuLypcbiAqIGNhbGxlZCBieSB0aGUgdHlwZS1jaGVja2VyIHdoZW4gaXQgbmVlZHMgdG8gZmV0Y2ggYSBmaWxlXG4gKi9cbmZ1bmN0aW9uIF9mZXRjaChhZGRyZXNzOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuXHRyZXR1cm4gU3lzdGVtLmZldGNoKHsgYWRkcmVzczogYWRkcmVzcywgbmFtZTogYWRkcmVzcywgbWV0YWRhdGE6IHt9IH0pXG5cdFx0LnRoZW4odGV4dCA9PiB7XG5cdFx0XHRsb2dnZXIuZGVidWcoYGZldGNoZWQgJHthZGRyZXNzfWApO1xuXHRcdFx0cmV0dXJuIHRleHQ7XG5cdFx0fSlcbn1cbiJdfQ==